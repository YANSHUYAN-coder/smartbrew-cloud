# 外卖功能完善方案

## 当前状态分析

### 已有基础
1. ✅ **数据库字段已就绪**
   - `delivery_company`: 配送方式（当前默认"门店自提"）
   - `delivery_sn`: 物流单号
   - `delivery_time`: 发货时间
   - 收货地址相关字段完整（receiver_name, receiver_phone, receiver_province等）

2. ✅ **前端基础功能**
   - 地址管理功能完整
   - 订单确认页面有配送费字段（但当前为0）
   - 菜单页面有外卖/到店取切换（但未在订单确认页使用）

3. ⚠️ **当前问题**
   - 订单确认页面硬编码 `deliveryCompany: '门店自提'`
   - 没有配送方式选择功能
   - 没有配送费计算逻辑
   - 订单状态只有"待取餐"，没有区分到店取和外卖
   - 外卖订单缺少配送状态跟踪

---

## 需要完善的功能清单

### 一、前端功能完善

#### 1.1 订单确认页面 (`pages/order/confirm.vue`)

**需要修改：**
- [ ] **添加配送方式选择**
  - 添加"到店取"和"外卖"两个选项
  - 根据选择的配送方式显示/隐藏地址选择
  - 外卖时显示配送费
  - 到店取时隐藏地址选择（或使用默认门店地址）

- [ ] **配送费计算**
  - 调用后端API获取配送费（根据地址距离计算）
  - 或前端简单规则：固定配送费/距离计算
  - 显示配送费明细

- [ ] **地址验证**
  - 外卖订单必须选择收货地址
  - 到店取订单可以不需要地址（或使用门店地址）

- [ ] **提交订单时传递配送方式**
  - 修改 `deliveryCompany` 字段，根据选择传递"门店自提"或"外卖配送"

#### 1.2 订单详情页面 (`pages/order/detail.vue`)

**需要修改：**
- [ ] **区分显示到店取和外卖订单**
  - 到店取：显示取餐码、门店地址
  - 外卖：显示配送地址、配送状态、预计送达时间

- [ ] **订单状态显示优化**
  - 到店取：待付款 → 待制作 → 制作中 → **待取餐** → 已完成
  - 外卖：待付款 → 待制作 → 制作中 → **待配送** → **配送中** → **已送达** → 已完成

- [ ] **配送信息展示**
  - 显示配送方式
  - 显示配送单号（如果有）
  - 显示预计送达时间
  - 显示配送员信息（如果有）

#### 1.3 订单列表页面 (`pages/order/list.vue`)

**需要修改：**
- [ ] **订单卡片显示配送方式标识**
  - 显示"到店取"或"外卖"标签
  - 外卖订单显示配送状态

- [ ] **状态筛选优化**
  - 考虑是否需要区分"待取餐"和"待配送"状态

#### 1.4 菜单页面 (`pages/menu/index.vue`)

**需要修改：**
- [ ] **确保订单类型传递到确认页**
  - 当前有 `orderType` 切换，需要传递到订单确认页
  - 或直接在确认页重新选择

---

### 二、后端功能完善

#### 2.1 订单服务 (`OrderServiceImpl.java`)

**需要修改：**
- [ ] **配送方式处理**
  - 根据 `deliveryCompany` 判断是到店取还是外卖
  - 外卖订单：必须验证地址，计算配送费
  - 到店取订单：可以生成取餐码

- [ ] **配送费计算**
  - 创建 `DeliveryFeeService` 服务
  - 根据配送地址计算配送费（距离、重量、时段等）
  - 支持免配送费规则（如满额免配送、会员免配送）

- [ ] **订单状态扩展**
  - 方案A：复用现有状态，通过 `deliveryCompany` 区分
    - 状态3：到店取显示"待取餐"，外卖显示"待配送"
  - 方案B：新增订单状态（推荐）
    - 新增状态：6->待配送，7->配送中，8->已送达
    - 或使用子状态字段区分

- [ ] **配送时间估算**
  - 根据距离、时段、天气等因素估算配送时间
  - 保存到订单表或单独的表

- [ ] **配送范围限制**
  - 验证配送地址是否在配送范围内
  - 超出范围提示用户或拒绝下单

#### 2.2 订单实体扩展 (`OmsOrder.java`)

**需要新增字段（可选）：**
- [ ] `delivery_fee`: 配送费金额
- [ ] `delivery_status`: 配送状态（如果不用订单状态区分）
- [ ] `estimated_delivery_time`: 预计送达时间
- [ ] `actual_delivery_time`: 实际送达时间
- [ ] `delivery_distance`: 配送距离（公里）
- [ ] `delivery_person_name`: 配送员姓名
- [ ] `delivery_person_phone`: 配送员电话

#### 2.3 配送费服务（新建）

**需要创建：**
- [ ] `DeliveryFeeService.java`
  - `calculateDeliveryFee(addressId, orderAmount)`: 计算配送费
  - `checkDeliveryRange(addressId)`: 检查是否在配送范围内
  - `estimateDeliveryTime(addressId)`: 估算配送时间

#### 2.4 API接口扩展

**需要新增/修改：**
- [ ] `POST /app/order/create` - 创建订单
  - 增加配送费计算
  - 增加配送范围验证

- [ ] `GET /app/order/calculate-delivery-fee` - 计算配送费（前端实时计算用）
  - 参数：addressId, orderAmount
  - 返回：配送费、是否在配送范围内、预计送达时间

- [ ] `POST /app/order/update-delivery-status` - 更新配送状态（管理端或配送端调用）
  - 更新配送状态、配送员信息、配送单号等

---

### 三、数据库扩展

#### 3.1 订单表扩展 (`oms_order`)

**需要新增字段：**
```sql
ALTER TABLE `oms_order` 
ADD COLUMN `delivery_fee` decimal(10, 2) DEFAULT 0.00 COMMENT '配送费',
ADD COLUMN `delivery_status` int DEFAULT NULL COMMENT '配送状态：0->待配送；1->配送中；2->已送达',
ADD COLUMN `estimated_delivery_time` datetime DEFAULT NULL COMMENT '预计送达时间',
ADD COLUMN `actual_delivery_time` datetime DEFAULT NULL COMMENT '实际送达时间',
ADD COLUMN `delivery_distance` decimal(10, 2) DEFAULT NULL COMMENT '配送距离（公里）',
ADD COLUMN `delivery_person_name` varchar(50) DEFAULT NULL COMMENT '配送员姓名',
ADD COLUMN `delivery_person_phone` varchar(20) DEFAULT NULL COMMENT '配送员电话';
```

#### 3.2 门店配置表（可选，用于配送范围）

**如果需要门店配送范围管理：**
```sql
CREATE TABLE `oms_store` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `store_name` varchar(100) NOT NULL COMMENT '门店名称',
  `store_address` varchar(200) NOT NULL COMMENT '门店地址',
  `longitude` decimal(10, 7) DEFAULT NULL COMMENT '经度',
  `latitude` decimal(10, 7) DEFAULT NULL COMMENT '纬度',
  `delivery_range` decimal(10, 2) DEFAULT 5.00 COMMENT '配送范围（公里）',
  `delivery_fee_base` decimal(10, 2) DEFAULT 5.00 COMMENT '基础配送费',
  `free_delivery_threshold` decimal(10, 2) DEFAULT 50.00 COMMENT '免配送费门槛',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) COMMENT='门店信息表';
```

---

### 四、业务逻辑完善

#### 4.1 配送费计算规则

**建议规则：**
1. **基础配送费**：固定费用（如5元）
2. **距离费用**：超出基础距离（如3公里）后，每公里加收费用
3. **时段费用**：高峰时段（如11:00-13:00, 17:00-19:00）加收费用
4. **免配送费**：
   - 订单金额满XX元免配送费
   - 会员等级达到XX级免配送费
   - 特殊活动免配送费

#### 4.2 订单状态流转

**到店取订单：**
```
待付款 → 待制作 → 制作中 → 待取餐 → 已完成
```

**外卖订单：**
```
待付款 → 待制作 → 制作中 → 待配送 → 配送中 → 已送达 → 已完成
```

**状态更新触发：**
- 待配送：制作完成后，系统自动更新（外卖订单）
- 配送中：配送员接单后更新
- 已送达：配送员确认送达后更新
- 已完成：用户确认收货后更新

#### 4.3 配送范围限制

**建议规则：**
- 默认配送范围：门店周围5公里
- 超出范围：提示用户或拒绝下单
- 支持多门店：根据用户地址选择最近门店

---

### 五、管理端功能（可选）

#### 5.1 订单管理
- [ ] 区分显示到店取和外卖订单
- [ ] 外卖订单配送状态管理
- [ ] 配送员分配功能

#### 5.2 配送管理
- [ ] 配送员管理
- [ ] 配送单分配
- [ ] 配送状态更新

#### 5.3 门店管理
- [ ] 门店信息配置
- [ ] 配送范围设置
- [ ] 配送费规则配置

---

## 实施优先级建议

### 第一阶段（核心功能）
1. ✅ 前端：订单确认页添加配送方式选择
2. ✅ 后端：配送费计算服务
3. ✅ 数据库：订单表添加配送费字段
4. ✅ 后端：订单创建时处理配送费

### 第二阶段（状态管理）
1. ✅ 订单状态扩展（区分到店取和外卖）
2. ✅ 前端：订单详情页区分显示
3. ✅ 前端：订单列表页显示配送方式

### 第三阶段（配送跟踪）
1. ✅ 配送状态管理
2. ✅ 配送时间估算
3. ✅ 配送员信息管理

### 第四阶段（高级功能）
1. ✅ 配送范围限制
2. ✅ 多门店支持
3. ✅ 配送费规则配置化

---

## 注意事项

1. **向后兼容**：现有订单数据需要兼容，`deliveryCompany` 为"门店自提"的订单应正常显示
2. **配送费计算**：建议先实现简单规则，后续再优化
3. **状态管理**：如果不想新增状态码，可以通过 `deliveryCompany` 和现有状态组合判断
4. **测试重点**：
   - 到店取和外卖订单的完整流程
   - 配送费计算的准确性
   - 订单状态流转的正确性

---

## 相关文件清单

### 前端文件
- `coffee-app-uniapp/pages/order/confirm.vue` - 订单确认页
- `coffee-app-uniapp/pages/order/detail.vue` - 订单详情页
- `coffee-app-uniapp/pages/order/list.vue` - 订单列表页
- `coffee-app-uniapp/pages/menu/index.vue` - 菜单页
- `coffee-app-uniapp/services/order.js` - 订单服务

### 后端文件
- `coffee-service-system/src/main/java/com/coffee/system/service/impl/OrderServiceImpl.java` - 订单服务实现
- `coffee-service-system/src/main/java/com/coffee/system/domain/entity/OmsOrder.java` - 订单实体
- `coffee-common/src/main/java/com/coffee/common/dict/OrderStatus.java` - 订单状态枚举
- `coffee-common/src/main/java/com/coffee/common/dto/CreateOrderRequest.java` - 创建订单请求
- `coffee-web-app/src/main/java/com/coffee/app/controller/AppOrderController.java` - 订单控制器

### 数据库文件
- `coffee-service-system/src/main/resources/db/coffee_cloud.sql` - 数据库脚本

