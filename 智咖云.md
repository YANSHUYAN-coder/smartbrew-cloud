# 智咖·云 (SmartBrew AI) - 智能咖啡店实战项目需求文档

## 1. 项目背景与目标

本项目旨在构建一个集 **B2C 用户点单 APP**、**B2B 门店管理后台** 以及 **AI 智能服务** 于一体的现代化咖啡零售系统。 核心目标是利用 **Spring AI Alibaba** 技术栈，实现“懂咖啡、懂用户”的智能交互体验，通过 RAG 技术解决大模型在特定领域（如店内特调配方、当季新品）的幻觉问题。

**项目阶段定义：**

- **阶段一（当前）**：基于 Spring Boot 的**模块化单体架构**。重业务逻辑与 AI 实现，部署简单（单进程）。
- **阶段二（未来）**：基于 Spring Cloud Alibaba 的**微服务架构**。重服务治理与高并发，将单体拆分为多个独立服务。

## 2. 技术架构选型

### 2.1 后端技术栈 (阶段一：单体版)

- **开发语言**: Java 17+
- **核心框架**: Spring Boot 3.x (不引入 Spring Cloud 组件)
- **AI 框架**: **Spring AI Alibaba** (仅使用其 AI 能力接入通义千问，暂不使用 Nacos/Sentinel)
- **权限安全**: Spring Security + JWT
- **持久层**: MyBatis-Plus
- **数据库**: MySQL 8.0
- **向量数据库**: PgVector (基于 PostgreSQL) 或 SimpleVectorStore (本地文件，仅供测试)
- **缓存**: Redis
- **对象存储**: MinIO 或 阿里云 OSS
- **构建工具**: Maven (多模块构建)

### 2.2 模块划分 (Module Structure)

采用**模块化单体**设计，各模块在物理上分离（不同的 Maven Module），但在运行时期打包在同一个 Jar 中，或者分为 App 和 Admin 两个 Jar。

- `coffee-root` (父工程：管理依赖版本)
  - `coffee-common` (公共模块：DTO, VO, Result, Utils)
  - `coffee-mbg` (持久层：Entity, Mapper, XML)
  - `coffee-security` (安全模块：JWT, Security Config)
  - `coffee-api` (API 接口定义层：为未来 Feign Client 做准备)
  - `coffee-service-system` (核心业务实现：用户、商品、订单)
  - `coffee-service-ai` (AI 业务实现：RAG, LLM交互)
  - `coffee-web-admin` (管理端启动入口：依赖 system 和 ai 模块)
  - `coffee-web-app` (用户端启动入口：依赖 system 和 ai 模块)

### 2.3 架构演进路线 (Spring Boot -> Spring Cloud)

为确保未来能平滑迁移到 Spring Cloud，开发时需遵守以下规范：

1. **接口隔离原则**：
   - 模块间调用**禁止**直接 `new` 对象。
   - 必须通过 `Interface` 进行调用。
   - *未来迁移*：将 `Interface` 层的实现从“本地 Bean 注入”改为 “OpenFeign 远程调用”。
2. **数据库解耦**：
   - 虽然现在共用一个 MySQL 库，但**禁止跨模块连表查询 (Join)**。
   - 例如：订单表关联用户表，必须先查订单，拿到 userId，再调用户服务查用户信息，在内存中组装。
   - *未来迁移*：直接把表拆分到不同的数据库实例，业务代码无需修改。
3. **配置分离**：
   - 尽量将 AI 相关的配置（Key, URL）与业务数据库配置分开。

### 2.4 前端技术栈 (新增)

**C端：用户 APP/小程序**

- **框架**: **UniApp** (基于 Vue 3) - 实现一套代码发布到微信小程序、Android、iOS。
- **UI 组件库**: **uView UI 2.0** (功能最全) 或 **ThorUI**。
- **网络请求**: `luch-request` (类似 Axios 的封装)。
- **AI 交互**: 使用 `uni.request` 的 `enableChunked: true` 支持流式响应 (SSE) 接收 AI 回复。

**B端：门店管理后台**

- **框架**: **Vue 3** + **Vite** + **TypeScript**。
- **UI 组件库**: **Element Plus** (业界标准，文档完善)。
- **图表库**: **ECharts** (用于销售数据大屏)。
- **状态管理**: **Pinia**。
- **脚手架**: 推荐使用开源的 Admin 模板 (如 `vue-element-plus-admin` 或 `vben-admin` 精简版) 以节省布局开发时间。

## 3. 功能模块详解

### 3.1 C端：用户 APP (User Mobile App)

**核心业务：**

1. **用户体系**
   - 微信一键登录 / 手机号验证码注册。
   - **会员成长值**：根据消费金额升级（银牌、金牌、钻石），不同等级享受不同折扣。
2. **智能菜单 (Menu)**
   - 商品分类展示（当季新品、美式、拿铁、非咖啡）。
   - 商品详情：多规格选择（冷/热、糖度、奶类替换）。
   - **AI 推荐标签**：根据天气或用户历史，自动打标（例如：下雨天推荐“暖心热可可”）。
3. **购物车与结算**
   - 添加/修改购物车商品。
   - 优惠券自动核销计算。
   - 模拟支付流程（对接支付宝沙箱或模拟支付接口）。
4. **订单管理**
   - 订单状态流转：待支付 -> 制作中 -> 待取餐/配送中 -> 已完成。
   - **取餐码生成**：生成二维码或数字口令。
5. **AI 咖啡助手 (Floating Chatbot)**
   - **入口**：APP 首页右下角悬浮窗。
   - **功能**：
     - **知识问答 (RAG)**：用户问“耶加雪菲是什么味道？”，AI 基于后台上传的知识库回答。
     - **口味推荐**：用户说“我今天很累，想喝点提神的，但不要太苦”，AI 推荐具体 SKU 并提供“一键加购”按钮。

### 3.2 B端：管理后台 (Admin Dashboard)

**核心业务：**

1. **数据大屏 (Dashboard)**
   - 今日销售额、订单量、热销 Top5。
   - AI 服务调用次数统计。
2. **商品管理**
   - 商品 CRUD、上下架、库存管理。
   - SKU 规格管理（中杯/大杯、燕麦奶/全脂奶）。
3. **订单中心**
   - **接单大厅**：实时刷新新订单，咖啡师点击“开始制作”、“制作完成”。
   - 退单处理与异常订单管理。
4. **RAG 知识库管理 (AI Knowledge Base)**
   - **文档上传**：管理员上传 PDF/Word/TXT（例如《2025春季新品培训手册.pdf》、《咖啡豆产地介绍.txt》）。
   - **向量化处理**：后台调用 Spring AI 接口将文档切片并存入向量数据库。
   - **测试窗口**：管理员可以在后台模拟用户提问，验证 AI 回答的准确性。
5. **营销中心**
   - 优惠券发放（注册赠送、满减券）。
   - 轮播图广告配置。

## 4. AI 核心功能设计 (Spring AI Alibaba + RAG)

这是本项目的亮点，需重点打磨：

### 4.1 知识库构建流程 (RAG Pipeline)

1. **ETL 阶段**: 管理员上传咖啡相关文档。
2. **Embedding**: 使用 Spring AI 的 `EmbeddingModel` 将文本转化为向量。
3. **Store**: 将向量和元数据存储到 Vector DB。

### 4.2 智能问答流程

1. **Retrieve (检索)**: 用户提问 -> 将问题向量化 -> 在向量库中搜索最相似的 top-k 个文本片段。
2. **Augment (增强)**: 将检索到的文本片段作为 Context (上下文)，拼接到 Prompt (提示词) 中。
   - *System Prompt 示例*: "你是一个专业的咖啡师助手。请根据以下提供的上下文信息回答用户的问题。如果上下文中没有答案，请礼貌地回答不知道，不要编造。"
3. **Generate (生成)**: 调用 Spring AI Alibaba ChatModel (通义千问) 生成最终回复。

### 4.3 扩展 AI 功能 (加分项)

- **情感化评论分析**: 对用户评价进行情感分析（正向/负向），自动生成回复草稿给管理员审核。
- **OCR 识图**: 用户上传一张其他店的咖啡图片，AI 识别并推荐自家店相似的产品。

## 5. 数据库设计概要 (核心表)

1. **`ums_member` (会员表)**: ID, 用户名, 手机号, 积分, 成长值, 会员等级ID。
2. **`pms_product` (商品表)**: ID, 名称, 图片, 描述, 基础价格, 销量, 上架状态。
3. **`pms_sku_stock` (库存/规格表)**: ID, 商品ID, 规格JSON(大杯,热,半糖), 价格, 库存。
4. **`oms_order` (订单表)**: ID, 订单号, 会员ID, 总金额, 支付状态, 订单状态, 支付时间。
5. **`ai_knowledge_doc` (知识库文档表)**: ID, 文件名, 文件路径, 向量化状态, 上传时间。
6. **`ai_vector_store` (向量存储)**: (通常由 Vector DB 管理，若用 PGVector 则为专门的表)。

## 6. API 接口示例

### 用户端

- `GET /api/app/home/content`: 获取首页轮播图、推荐商品。

- `POST /api/app/cart/add`: 添加购物车。

- `POST /api/app/order/create`: 创建订单。

- `GET /api/app/ai/chat?question=xxx`: 

  $$SSE流式$$

   与 AI 助手对话。

### 管理端

- `POST /api/admin/product/create`: 创建商品。
- `POST /api/admin/ai/doc/upload`: 上传 RAG 知识文档（触发向量化）。
- `PUT /api/admin/order/status`: 更新订单状态（制作完成）。

## 7. 开发计划建议

1. **第一阶段 (基础建设)**: 搭建 Maven 多模块工程，配置 MySQL、Redis，完成单体 Boot 启动调试。
2. **第二阶段 (核心业务)**: 完成商品、购物车、下单流程（注意：服务间调用使用 Java Interface，避免数据库 Join）。
3. **第三阶段 (AI 接入)**: 引入 Spring AI Alibaba，配置 API KEY，跑通 RAG 流程。
4. **第四阶段 (APP 联调)**: 前后端联调，完善数据展示。
5. **第五阶段 (云原生改造 - 待定)**: 引入 Nacos 作为注册/配置中心，将 System 和 AI 模块拆分为独立进程，引入 Gateway 网关。